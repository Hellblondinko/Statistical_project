---
title: "Project_Mollusca"
author: "Alexandra Tsitrina"
date: "10/8/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Необходимые нам библиотеки:
```{r}
options(encoding = "UTF-8")

PkgNames <- c("dplyr", "magrittr", "ggplot2", "reshape2", "purrr","utf8")
invisible(suppressMessages(suppressWarnings(lapply(PkgNames, require, character.only = T))))


```

### Dataframe generation ###
Соберем полную таблицу с данными из исходных файлов и выведем структуру получившегося объекта:

```{r}
abs_way <- getwd()
#please insert the absolute way to your files
abs_way <- normalizePath(abs_way)

data_files<- dir(abs_way, pattern =".csv")
Mollusca <- list()
for(i in 1:length(data_files)){
file <- read.table(data_files[i], header=TRUE, sep=",", stringsAsFactors=TRUE)


Mollusca <- rbind(Mollusca, file)
}
str(Mollusca)
    
```

## Renaming and type switching in dataframe ###
Переименуем вторую переменную нашего датафрема из "Sex..1...male..2...female..3...uvenil." в "Sex". Затем изменим тип переменной Diameter на numeric. Т.к.в нашем датасете есть еще 2 переменные строкового типа, а именно Lenght и Rings, то проверим их на уникальные элементы. Как мы видим, в интересующих нас колонках обнаруживаются неправильно записанные данные. Заменяем эти значения либо на правильный формат ("nine" на "9"), либо на NA. Проверим все переменные нашего датафрема на наличие NA-значений до и после работы с отдельными наблюдениями, как мы видим, количество NA после выросло.

```{r}
colnames(Mollusca)[colnames(Mollusca) == 'Sex..1...male..2...female..3...uvenil.'] <- 'Sex'
colnames(Mollusca)

Mollusca %>% select_all() %>%summarise_all(funs(sum(is.na(.))))
Mollusca$Diameter <-  as.numeric(Mollusca$Diameter,quietly = TRUE) #convert  in numeric type
Rings <- unique(Mollusca$Rings)
print(Rings)
Mollusca$Rings[Mollusca$Rings == "nine"] <- "9"
Length <- unique(Mollusca$Length)
print(Length)
Mollusca$Length[Mollusca$Length == "No data! I forgot to mesure it!("] <- NA

Mollusca$Rings <- as.numeric(Mollusca$Rings, quietly = TRUE)
Mollusca$Length <-  as.double(Mollusca$Length, queitly = TRUE)
Mollusca %>% select_all() %>% summarise_all(funs(sum(is.na(.))))

```
Найдем все уникальные значения 



```{r}
sex <- unique(Mollusca$Sex)
print(sex)#check for unique values
Mollusca$Sex[Mollusca$Sex == "three"] <- "3" 
Mollusca$Sex[Mollusca$Sex == "one"] <- "1"
Mollusca$Sex[Mollusca$Sex == "male"] <- "1"
sex_new <- unique(Mollusca$Sex) #after changing the uncorrect values
Mollusca$Sex <- factor(Mollusca$Sex, levels = c("1", "2","3"), labels = c("Male", "Female", "Uvenile"))
str(Mollusca)
#Sex as factor

```

Outliers

```{r}
size_weight = melt(Mollusca, id.vars = "Sex", measure.vars = c("Rings","Length", "Diameter", "Height", "Whole_weight", "Shucked_weight", "Viscera_weight", "Shell_weight"), quietly = TRUE)
ggplot(size_weight, aes(x = variable,y = value),quietly = TRUE) + facet_wrap(~variable, scale="free") + geom_boxplot(aes(fill = variable), size = 1)+ labs( y = "value", x = NULL) + theme(axis.text.x = element_text(angle=0, hjust=1, vjust=0.5)) 

```
Calculating and removing the outliers

```{r}

outliers <- function(dataframe){
  dataframe %>%
      select_if(is.numeric) %>% 
      map(~ boxplot.stats(.x)$out)
  }

List_of_outl <- outliers(Mollusca)
str(List_of_outl)
out_Rings <- List_of_outl$Rings

max(Mollusca$Rings)
Mollusca <- mutate(Mollusca, Age = case_when(Rings <=5 ~ 1,
                       (Rings >= 6 & Rings <= 10) ~ 2,
                       (Rings >= 11 & Rings >16) ~ 3,
                       (Rings <= 16 & Rings <=30) ~ 4))
                        


Mollusca$Age <- factor(Mollusca$Age, levels = c(1,2,3,4), labels = c("baby", "young", "teen","adult"))

max(Mollusca$Rings)






```
в переменной Ring количество выбросов довольно значительное, 278 наблюдений, если посмотреть на значения, то мы видим, что это либо очень юные особи, либо очень старые.

```{r}
outlierreplacement <- function(dataframe){
   dataframe %>%          
           map_if(is.numeric, ~ replace(.x, .x %in% boxplot.stats(.x)$out, NA)) %>%
           bind_cols }

outlierreplacement(Mollusca[,1,3:9])
Mollusca <- Mollusca[complete.cases(Mollusca),]

Mollusca %>% select_all() %>% summarise_all(funs(sum(is.na(.))))
cor(Mollusca[,3:9])
pairs(Mollusca[,3:9])
``` 
Глядя на полученную таблицу можно заметить, что переменные, характеризующие вес или размер моллюска, очень сильно коррелируют между собой. Логично было бы применить схлопнуть наши 6 переменных в 2, описывающие изменения размера и веса в зависимости от пола и возраста особи

Проверка на нормальность распределения всех переменных кроме Sex
```{r}
shapiro_test_df <- function(df, bonf= FALSE, alpha= 0.05) {
        l <- lapply(df, shapiro.test)
        s <- do.call("c", lapply(l, "[[", 1))
        p <- do.call("c", lapply(l, "[[", 2))
        if (bonf == TRUE) {
                sig <- ifelse(p > alpha / length(l), "H0", "Ha")
        } else {
                sig <- ifelse(p > alpha, "H0", "Ha")
        }
        return(list(statistic= s,
                    p.value= p,
                    significance= sig,
                    method= ifelse(bonf == TRUE, "Shapiro-Wilks test with Bonferroni Correction",
                                   "Shapiro-Wilks test without Bonferroni Correction")))
}

Mollusca %>% select(where(is.numeric))%>% shapiro_test_df()
```

Как видно из таблицы, данные имеют ненормальное распределение (Ha), поэтому для дальнейшего анализа необходимо использовать непараметрические критерии.
```{r}

Diam <- aggregate(Mollusca$Diameter ~ Mollusca$Sex + Mollusca$Age, data = Mollusca, function(x) c (mean = mean(x),median = median(x),sd = sd(x),first_quantile = quantile(x,0.25),third_quantile = quantile(x,0.75)))
Wheight <- aggregate(Mollusca$Whole_weight ~ Mollusca$Sex + Mollusca$Age, data = Mollusca, function(x) c (mean = mean(x),median = median(x),sd = sd(x),first_quantile = quantile(x,0.25),third_quantile = quantile(x,0.75)))

Sum_Diam <- cbind(Diam[-ncol(Diam)], Diam[[ncol(Diam)]])
Sum_Wheight <- cbind(Wheight[-ncol(Wheight)], Wheight[[ncol(Wheight)]])
print(Sum_Diam)
ggplot(Mollusca, aes(x = Diameter, y = Whole_weight, col = Sex))+
  geom_smooth()+facet_grid(Mollusca$Sex)



```
Выведем показатели распределения длинны по группам (возраст, пол)
```{r}
print(Sum_Wheight)
```
И показатели веса
 В общем случае, для моллюсков разного пола, среднее и sd равно
```{r}
Mollusca %>% group_by(Sex) %>% select(Length, Whole_weight) %>% summarise_each(funs(mean, sd)) # 3

ungroup(Mollusca)

small <- Mollusca %>% filter(Height < 0.165)
percent_of_small <- nrow(small) / nrow(Mollusca) *100 #4

quantile_vec <- quantile(Mollusca$Length,c(0,0.25,0.5,0.75, 0.92, 1))
# quantile_vec[5] - ответ на 5

```
 Создание стандартизованной переменной длины и сравнение диаметра у двух групп, молодые и взрослые моллюски. Расчет корреляции Пирсона для переменных длина и общий вес. 
 
 
```{r}
Mollusca$Lenght_z_scores <- scale(Mollusca$Length, center = TRUE, scale = TRUE) #6
 y_Diam <- Mollusca %>% filter(Rings == 5) %>% select(Diameter) 
 o_Diam <- Mollusca %>% filter(Rings == 15) %>% select(Diameter) 
 wilcox.test(o_Diam$Diameter, y_Diam$Diameter) #7
 

  ggplot(Mollusca, aes(x = Age, y = Diameter, col = Sex))+
   geom_boxplot()
  ggplot(Mollusca, aes(x = Age, y = Whole_weight, col = Sex))+
   geom_boxplot()
  

 
  

 

```

```{r}



```